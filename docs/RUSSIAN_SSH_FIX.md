# ðŸ”§ ÐšÐ°Ðº Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ SSH Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ð¿Ð¾ Ð¿Ð°Ñ€Ð¾Ð»ÑŽ

## ðŸ”´ ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°

Ð’Ñ‹ Ð¿Ñ‹Ñ‚Ð°ÐµÑ‚ÐµÑÑŒ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ðº VM:
```bash
ssh ubuntu@192.168.200.100
```

Ð˜ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚Ðµ:
```
Permission denied (publickey).
```

**ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð½Ðµ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ÑÑ!** âŒ

## âœ… Ð ÐµÑˆÐµÐ½Ð¸Ðµ

### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: ÐŸÐ•Ð Ð•Ð¡ÐžÐ—Ð”ÐÐ¢Ð¬ VM (Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ) â­

Ð­Ñ‚Ð¾ **ÑÐ°Ð¼Ñ‹Ð¹ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ Ð¸ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹** ÑÐ¿Ð¾ÑÐ¾Ð±, Ñ‚Ð°Ðº ÐºÐ°Ðº Ð² cloud-init ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð²ÑÐµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ.

```bash
cd ~/dns_server/examples/local

# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿ÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ VM
bash ../../scripts/recreate-vm.sh
```

Ð¡ÐºÑ€Ð¸Ð¿Ñ‚:
1. Ð£Ð´Ð°Ð»Ð¸Ñ‚ ÑÑ‚Ð°Ñ€ÑƒÑŽ VM
2. Ð¡Ð¾Ð·Ð´Ð°ÑÑ‚ Ð½Ð¾Ð²ÑƒÑŽ VM Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹
3. ÐŸÐ¾Ð´Ð¾Ð¶Ð´ÐµÑ‚ 60 ÑÐµÐºÑƒÐ½Ð´ Ð¿Ð¾ÐºÐ° VM Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ÑÑ

**ÐŸÐ¾ÑÐ»Ðµ ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°Ð¹Ñ‚ÐµÑÑŒ:**
```bash
ssh ubuntu@192.168.200.100
```

**ÐŸÐ°Ñ€Ð¾Ð»ÑŒ:** `ubuntu`

---

### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: Ð˜ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ VM Ñ‡ÐµÑ€ÐµÐ· SSH ÐºÐ»ÑŽÑ‡

Ð•ÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ SSH ÐºÐ»ÑŽÑ‡ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ `~/.ssh/id_rsa`):

```bash
cd ~/dns_server

# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
bash scripts/fix-existing-vm-ssh.sh
```

Ð¡ÐºÑ€Ð¸Ð¿Ñ‚:
1. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÑ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ðº VM Ð¿Ð¾ SSH ÐºÐ»ÑŽÑ‡Ñƒ
2. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐµÑ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð½Ð° VM
3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ SSH ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
4. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ SSH ÑÐµÑ€Ð²Ð¸Ñ

**ÐŸÐ¾ÑÐ»Ðµ ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°Ð¹Ñ‚ÐµÑÑŒ:**
```bash
ssh ubuntu@192.168.200.100
```

**ÐŸÐ°Ñ€Ð¾Ð»ÑŒ:** `ubuntu`

---

### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 3: Ð§ÐµÑ€ÐµÐ· ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒ virsh (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ñ…Ð¾ÑÑ‚Ñƒ)

Ð•ÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ñ…Ð¾ÑÑ‚Ñƒ, Ð³Ð´Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð° VM:

```bash
# ÐÐ° Ñ…Ð¾ÑÑ‚-Ð¼Ð°ÑˆÐ¸Ð½Ðµ
sudo virsh console dns-server
```

ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·ÑƒÐ¹Ñ‚ÐµÑÑŒ:
- **Username:** `ubuntu`
- **Password:** `ubuntu` (Ð¸Ð»Ð¸ Ð´Ñ€ÑƒÐ³Ð¾Ð¹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð²Ñ‹ ÑƒÐºÐ°Ð·Ð°Ð»Ð¸)

Ð—Ð°Ñ‚ÐµÐ¼ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ:

```bash
# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³
sudo tee /etc/ssh/sshd_config.d/01-custom-auth.conf > /dev/null <<'EOF'
PasswordAuthentication yes
PermitRootLogin yes
KbdInteractiveAuthentication yes
PubkeyAuthentication yes
UsePAM yes
EOF

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚ÑƒÑŽÑ‰Ð¸Ð¹ Ñ„Ð°Ð¹Ð»
sudo rm -f /etc/ssh/sshd_config.d/50-cloud-init.conf

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³
sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ SSH
sudo systemctl restart ssh

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼
sudo sshd -T | grep passwordauthentication
```

Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ:
```
passwordauthentication yes
```

---

## ðŸŽ¯ Ð§Ñ‚Ð¾ Ð±Ñ‹Ð»Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾

### ÐšÐ¾Ñ€Ð½ÐµÐ²Ð°Ñ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹:

1. **Cloud-init ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ð» Ñ„Ð°Ð¹Ð»** `/etc/ssh/sshd_config.d/50-cloud-init.conf` Ñ `PasswordAuthentication no`

2. **SSH Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¸ Ð² Ð°Ð»Ñ„Ð°Ð²Ð¸Ñ‚Ð½Ð¾Ð¼ Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ** Ð¸ **ÐŸÐ•Ð Ð’ÐÐ¯ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¸Ð²Ð° Ð¿Ð¾Ð±ÐµÐ¶Ð´Ð°ÐµÑ‚**

3. **Ð¡Ñ‚Ð°Ñ€Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ð»Ð°** `99-custom-auth.conf` - Ð¾Ð½ Ñ‡Ð¸Ñ‚Ð°Ð»ÑÑ **ÐŸÐžÐ¡Ð›Ð•** `50-cloud-init.conf`

4. **ÐŸÐ¾ÑÑ‚Ð¾Ð¼Ñƒ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°** `PasswordAuthentication yes` Ð¸Ð· `99-custom-auth.conf` **Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð»Ð°ÑÑŒ**!

### Ð ÐµÑˆÐµÐ½Ð¸Ðµ:

âœ… Ð¡Ð¾Ð·Ð´Ð°ÐµÑ‚ÑÑ **`01-custom-auth.conf`** - Ð¾Ð½ Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ÑÑ **ÐŸÐ•Ð Ð’Ð«Ðœ** (Ð´Ð¾ `50-cloud-init.conf`)

âœ… Ð£Ð´Ð°Ð»ÑÐµÑ‚ÑÑ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚ÑƒÑŽÑ‰Ð¸Ð¹ **`50-cloud-init.conf`**

âœ… ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ **`/etc/ssh/sshd_config`**

---

## ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°

ÐŸÐ¾ÑÐ»Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:

```bash
# 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
sudo sshd -T | grep passwordauthentication
# Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ: passwordauthentication yes

# 2. Ð¡Ð¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¾Ð²
ls -la /etc/ssh/sshd_config.d/
# Ð”Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ: 01-custom-auth.conf
# ÐÐ• Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ: 50-cloud-init.conf

# 3. Ð¡Ñ‚Ð°Ñ‚ÑƒÑ SSH
sudo systemctl status ssh
# Ð”Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ: active (running)
```

---

## â“ FAQ

### Q: ÐšÐ°ÐºÐ¾Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ?
**A:** `ubuntu` (Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð² `examples/local/variables.tf`)

### Q: ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ SSH Ð½Ðµ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ?
**A:** ÐŸÐ¾Ñ‚Ð¾Ð¼Ñƒ Ñ‡Ñ‚Ð¾ `PasswordAuthentication` Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½ Ð² SSH ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸

### Q: ÐœÐ¾Ð¶Ð½Ð¾ Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ SSH ÐºÐ»ÑŽÑ‡?
**A:** Ð”Ð°! ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÐºÐ»ÑŽÑ‡Ñƒ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾ Ñ Ð¿Ð°Ñ€Ð¾Ð»ÐµÐ¼:
```bash
ssh -i ~/.ssh/id_rsa ubuntu@192.168.200.100
```

### Q: ÐšÐ°Ðº Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ?
**A:** ÐŸÐ¾ÑÐ»Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº VM:
```bash
sudo passwd ubuntu
```

### Q: Ð“Ð´Ðµ Ð»Ð¾Ð³Ð¸ SSH?
**A:**
```bash
sudo journalctl -u ssh -n 50
```

---

## ðŸ› ï¸ Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ° SSH ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°
sudo sshd -t

# ÐŸÐ¾Ð»Ð½Ð°Ñ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ SSH
sudo sshd -T

# Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
sudo sshd -T | grep -i auth

# Ð›Ð¾Ð³Ð¸ SSH Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
sudo journalctl -u ssh -f
```

---

## ðŸ“š ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ

Ð¡Ð¼. **`docs/SSH_PASSWORD_AUTH_FIX.md`** Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð¸ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ.

---

**ÐÐ²Ñ‚Ð¾Ñ€:** Senior DevOps Engineer
**Ð”Ð°Ñ‚Ð°:** 2025-11-21
**Ð’ÐµÑ€ÑÐ¸Ñ:** 1.0
