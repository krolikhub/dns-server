# –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ "domain already exists"

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ `terraform apply` –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞:

```
Error: error defining libvirt domain: operation failed: domain 'dns-server' already exists with uuid 4e1f5a68-9f94-43a2-968c-fedd026237fd
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤ libvirt —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–æ–º–µ–Ω —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º, –∏ Terraform –Ω–µ –º–æ–∂–µ—Ç –µ–≥–æ —Å–æ–∑–¥–∞—Ç—å –∑–∞–Ω–æ–≤–æ.

## –†–µ—à–µ–Ω–∏—è

### ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 1: –£–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–æ–º–µ–Ω (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–≠—Ç–æ —Å–∞–º—ã–π —á–∏—Å—Ç—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Terraform.

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞:

```bash
# –ò–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
./scripts/cleanup-libvirt-domain.sh dns-server
```

#### –ò–ª–∏ –≤—Ä—É—á–Ω—É—é:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö VM
virsh list --all

# 2. –ï—Å–ª–∏ VM –∑–∞–ø—É—â–µ–Ω–∞, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ—ë
virsh destroy dns-server

# 3. –£–¥–∞–ª–∏—Ç—å VM –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
virsh undefine dns-server --remove-all-storage

# 4. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å terraform apply —Å–Ω–æ–≤–∞
cd examples/local
terraform apply
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ö–æ–≥–¥–∞ –≤—ã —Ö–æ—Ç–∏—Ç–µ —á–∏—Å—Ç—ã–π —Å—Ç–∞—Ä—Ç –∏ —É –≤–∞—Å –Ω–µ—Ç –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –¥–æ–º–µ–Ω–µ.

---

### üîÑ –í–∞—Ä–∏–∞–Ω—Ç 2: –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–æ–º–µ–Ω –≤ Terraform

–≠—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç Terraform —É–ø—Ä–∞–≤–ª—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¥–æ–º–µ–Ω–æ–º.

```bash
cd examples/local

# 1. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é VM –≤ Terraform state
terraform import module.dns_server.libvirt_domain.dns_server dns-server

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
terraform apply
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ö–æ–≥–¥–∞ –¥–æ–º–µ–Ω –±—ã–ª —Å–æ–∑–¥–∞–Ω –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –≤–Ω–µ Terraform, –∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å –∏–º —É–ø—Ä–∞–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ Terraform.

**‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:** –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–º–µ–Ω–∞ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç –æ–ø–∏—Å–∞–Ω–Ω—ã—Ö –≤ Terraform.

---

### üßπ –í–∞—Ä–∏–∞–Ω—Ç 3: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ

–ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å –Ω—É–ª—è.

```bash
cd examples/local

# –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ Terraform (–µ—Å–ª–∏ state —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
terraform destroy -auto-approve

# –í–∞—Ä–∏–∞–Ω—Ç B: –í—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ virsh
virsh destroy dns-server 2>/dev/null || true
virsh undefine dns-server --remove-all-storage 2>/dev/null || true

# –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å–µ—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
virsh net-destroy dns-server-network 2>/dev/null || true
virsh net-undefine dns-server-network 2>/dev/null || true

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ
terraform apply
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã –∏–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ª—é–±–æ–≥–æ –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```bash
# –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –¥–æ–º–µ–Ω —É–¥–∞–ª–µ–Ω
virsh list --all | grep dns-server

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Terraform state
terraform state list | grep libvirt_domain

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
terraform apply
```

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–º–µ–Ω–µ
virsh dominfo dns-server

# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–æ–º–µ–Ω—ã —Å UUID
virsh list --all --uuid --name

# –ü–æ–∫–∞–∑–∞—Ç—å –¥–∏—Å–∫–∏ –¥–æ–º–µ–Ω–∞
virsh domblklist dns-server

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ—Ç–∏
virsh net-list --all
```

---

## –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –±—É–¥—É—â–µ–º

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Terraform –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏**
   - –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –¥–æ–º–µ–Ω—ã –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ `virsh`
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `terraform destroy` –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞**
   - –ò–∑–º–µ–Ω–∏—Ç–µ `vm_name` –≤ `terraform.tfvars` –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –¥–æ–º–µ–Ω

3. **–•—Ä–∞–Ω–∏—Ç–µ Terraform state**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ remote state (S3, Terraform Cloud) –¥–ª—è –∫–æ–º–∞–Ω–¥—ã
   - –ò–ª–∏ —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `terraform.tfstate` –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è

---

## –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç

```bash
# –ù–∞–π—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –¥–æ–º–µ–Ω–æ–º
ps aux | grep dns-server

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–∏—Ç—å –¥–æ–º–µ–Ω (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
virsh undefine dns-server --nvram --remove-all-storage || true

# –í—Ä—É—á–Ω—É—é —É–¥–∞–ª–∏—Ç—å –¥–∏—Å–∫–∏ –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å
sudo rm -f /var/lib/libvirt/pools/dns-server/*

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å libvirt
sudo systemctl restart libvirtd
```
