# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ virsh console

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ –∫–æ–Ω—Å–æ–ª–∏ VM:
```bash
sudo virsh console dns-server
```

–õ–æ–≥–∏–Ω **ubuntu/ubuntu** –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç! ‚ùå

## üîç –ü—Ä–∏—á–∏–Ω–∞

Cloud-init –º–æ–∂–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å —á–µ—Ä–µ–∑ –¥–∏—Ä–µ–∫—Ç–∏–≤—É `plain_text_passwd`. –≠—Ç–æ –∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö cloud-init.

## ‚úÖ –†–µ—à–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å —á–µ—Ä–µ–∑ virt-customize (–°–ê–ú–´–ô –ë–´–°–¢–†–´–ô) ‚≠ê

**–¢—Ä–µ–±—É–µ—Ç—Å—è**: –ø–∞–∫–µ—Ç `libguestfs-tools` –Ω–∞ —Ö–æ—Å—Ç-–º–∞—à–∏–Ω–µ

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ libguestfs-tools (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
sudo apt-get install -y libguestfs-tools

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å VM
sudo virsh shutdown dns-server

# –î–æ–∂–¥–∞—Ç—å—Å—è –ø–æ–ª–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (5-10 —Å–µ–∫—É–Ω–¥)
sleep 10

# –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ubuntu –Ω–∞ 'ubuntu'
sudo virt-customize -d dns-server --password ubuntu:password:ubuntu

# –ó–∞–ø—É—Å—Ç–∏—Ç—å VM —Å–Ω–æ–≤–∞
sudo virsh start dns-server

# –ü–æ–¥–æ–∂–¥–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ (30-60 —Å–µ–∫—É–Ω–¥)
sleep 30

# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–æ–Ω—Å–æ–ª–∏
sudo virsh console dns-server
```

**–õ–æ–≥–∏–Ω**: `ubuntu`
**–ü–∞—Ä–æ–ª—å**: `ubuntu`

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ VM

–ï—Å–ª–∏ virt-customize –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –º–æ–∂–Ω–æ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∏—Å–∫ VM:

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å VM
sudo virsh shutdown dns-server
sleep 10

# 2. –ù–∞–π—Ç–∏ –ø—É—Ç—å –∫ –¥–∏—Å–∫—É VM
sudo virsh domblklist dns-server

# 3. –°–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∏—Å–∫ (–æ–±—ã—á–Ω–æ /var/lib/libvirt/images/dns-server.qcow2)
sudo modprobe nbd max_part=8
sudo qemu-nbd --connect=/dev/nbd0 /var/lib/libvirt/images/dns-server.qcow2
sudo partprobe /dev/nbd0

# 4. –°–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–¥–µ–ª
sudo mkdir -p /mnt/vm-disk
sudo mount /dev/nbd0p1 /mnt/vm-disk

# 5. –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å —á–µ—Ä–µ–∑ chroot
sudo chroot /mnt/vm-disk /bin/bash
echo 'ubuntu:ubuntu' | chpasswd
exit

# 6. –†–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
sudo umount /mnt/vm-disk
sudo qemu-nbd --disconnect /dev/nbd0

# 7. –ó–∞–ø—É—Å—Ç–∏—Ç—å VM
sudo virsh start dns-server
sleep 30

# 8. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
sudo virsh console dns-server
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å VM —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –¥–ª—è –±—É–¥—É—â–∏—Ö VM)

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è:

```bash
cd ~/dns-server/examples/local
bash ../../scripts/recreate-vm.sh
```

–ù–æ —Å–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ **–∏—Å–ø—Ä–∞–≤–∏—Ç—å cloud-init –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é** (—Å–º. –Ω–∏–∂–µ).

---

## üõ†Ô∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ cloud-init –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö VM, –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

### –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–µ–∫—É—â–µ–º user-data.yml:

```yaml
users:
  - name: ubuntu
    plain_text_passwd: ${ubuntu_password}  # ‚Üê –ü–†–û–ë–õ–ï–ú–ê: –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å!
```

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ö–µ—à –ø–∞—Ä–æ–ª—è:

1. **–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ö–µ—à –ø–∞—Ä–æ–ª—è:**

```bash
# –î–ª—è –ø–∞—Ä–æ–ª—è 'ubuntu'
mkpasswd --method=SHA-512 --rounds=4096 ubuntu
```

–†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–∏–º:
```
$6$rounds=4096$SALT$HASHEDPASSWORD...
```

2. **–û–±–Ω–æ–≤–∏—Ç—å cloud-init/user-data.yml:**

–ó–∞–º–µ–Ω–∏—Ç—å:
```yaml
plain_text_passwd: ${ubuntu_password}
```

–ù–∞:
```yaml
passwd: ${ubuntu_password_hash}
```

3. **–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ examples/local/variables.tf:**

```terraform
variable "ubuntu_password_hash" {
  description = "–•–µ—à –ø–∞—Ä–æ–ª—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ubuntu"
  type        = string
  # –•–µ—à –¥–ª—è –ø–∞—Ä–æ–ª—è 'ubuntu'
  default     = "$6$rounds=4096$SALTSALT$5K8H3MXW..."  # –í–∞—à —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö–µ—à
  sensitive   = true
}
```

4. **–û–±–Ω–æ–≤–∏—Ç—å main.tf –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π:**

```terraform
data "template_file" "user_data" {
  template = file("${path.module}/../../cloud-init/user-data.yml")

  vars = {
    ubuntu_password_hash = var.ubuntu_password_hash
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  }
}
```

---

## üéØ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ª–æ–≥–∏–Ω –Ω–∞ –∫–æ–Ω—Å–æ–ª–∏ (–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)

–ï—Å–ª–∏ –Ω—É–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –Ω–∞ –∫–æ–Ω—Å–æ–ª–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏!):

–î–æ–±–∞–≤–∏—Ç—å –≤ `runcmd` —Å–µ–∫—Ü–∏—é cloud-init:

```yaml
runcmd:
  # –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ª–æ–≥–∏–Ω –Ω–∞ ttyS0 (serial console)
  - mkdir -p /etc/systemd/system/serial-getty@ttyS0.service.d
  - |
    cat > /etc/systemd/system/serial-getty@ttyS0.service.d/autologin.conf <<'EOF'
    [Service]
    ExecStart=
    ExecStart=-/sbin/agetty --autologin ubuntu --noclear %I $TERM
    EOF
  - systemctl daemon-reload
  - systemctl restart serial-getty@ttyS0.service
```

**–í–ù–ò–ú–ê–ù–ò–ï**: –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ª—é–±–æ–º—É, –∫—Ç–æ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Å–æ–ª–∏ VM, –≤–æ–π—Ç–∏ –±–µ–∑ –ø–∞—Ä–æ–ª—è!

---

## üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ª—é–±–æ–≥–æ –∏–∑ —Ä–µ—à–µ–Ω–∏–π:

```bash
# 1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–æ–Ω—Å–æ–ª–∏
sudo virsh console dns-server

# 2. –í–≤–µ—Å—Ç–∏ –ª–æ–≥–∏–Ω: ubuntu
# 3. –í–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å: ubuntu

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω
whoami
# –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å: ubuntu

# 5. –í—ã–π—Ç–∏ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏
# –ù–∞–∂–º–∏—Ç–µ Ctrl + ]
```

---

## ‚ùì FAQ

### Q: –ü–æ—á–µ–º—É plain_text_passwd –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?
**A:** –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞—Ä–æ–ª–µ–π –≤ cloud-init. –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞—Ö Ubuntu (–æ—Å–æ–±–µ–Ω–Ω–æ 22.04+) `plain_text_passwd` –º–æ–∂–µ—Ç –Ω–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞ —ç—Ç–∞–ø–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ `passwd` –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ.

### Q: –ö–∞–∫ —É–∑–Ω–∞—Ç—å, –ø—Ä–∏–º–µ–Ω–∏–ª—Å—è –ª–∏ –ø–∞—Ä–æ–ª—å?
**A:** –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ VM –ø–æ SSH (–µ—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç) –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
```bash
sudo getent shadow ubuntu
```
–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ `ubuntu:!:...` –∏–ª–∏ `ubuntu:*:...`, –∑–Ω–∞—á–∏—Ç –ø–∞—Ä–æ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.

### Q: –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SSH –≤–º–µ—Å—Ç–æ –∫–æ–Ω—Å–æ–ª–∏?
**A:** –î–∞! SSH –¥–æ—Å—Ç—É–ø –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–µ–º –∂–µ –ø–∞—Ä–æ–ª–µ–º:
```bash
ssh ubuntu@192.168.200.100
# –ü–∞—Ä–æ–ª—å: ubuntu
```

### Q: –ö–∞–∫ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è –Ω–∞ –∫–æ–Ω—Å–æ–ª–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)?
**A:** –°–º. —Ä–∞–∑–¥–µ–ª "–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ª–æ–≥–∏–Ω –Ω–∞ –∫–æ–Ω—Å–æ–ª–∏" –≤—ã—à–µ, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏!

---

## üîß –ì–æ—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `scripts/fix-vm-console-password.sh`:

```bash
#!/bin/bash
#
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ubuntu —á–µ—Ä–µ–∑ virt-customize
#

set -e

VM_NAME="${1:-dns-server}"
USERNAME="${2:-ubuntu}"
PASSWORD="${3:-ubuntu}"

echo "=========================================="
echo "–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –¥–ª—è VM: $VM_NAME"
echo "=========================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è libguestfs-tools
if ! command -v virt-customize &> /dev/null; then
    echo "‚ùå –û–®–ò–ë–ö–ê: virt-customize –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo ""
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ libguestfs-tools:"
    echo "  sudo apt-get install -y libguestfs-tools"
    exit 1
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ VM
echo "[1/4] –û—Å—Ç–∞–Ω–æ–≤–∫–∞ VM $VM_NAME..."
sudo virsh shutdown "$VM_NAME" 2>/dev/null || true
sleep 10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ VM –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
if sudo virsh domstate "$VM_NAME" | grep -q "running"; then
    echo "‚ö†Ô∏è  VM –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ..."
    sudo virsh destroy "$VM_NAME"
    sleep 5
fi

echo "‚úì VM –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
echo ""

# –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è
echo "[2/4] –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $USERNAME..."
sudo virt-customize -d "$VM_NAME" --password "${USERNAME}:password:${PASSWORD}"
echo "‚úì –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: $PASSWORD"
echo ""

# –ó–∞–ø—É—Å–∫ VM
echo "[3/4] –ó–∞–ø—É—Å–∫ VM..."
sudo virsh start "$VM_NAME"
echo "‚úì VM –∑–∞–ø—É—â–µ–Ω–∞"
echo ""

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
echo "[4/4] –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ VM (30 —Å–µ–∫—É–Ω–¥)..."
sleep 30

echo ""
echo "=========================================="
echo "‚úì –ì–æ—Ç–æ–≤–æ!"
echo "=========================================="
echo ""
echo "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è:"
echo ""
echo "  sudo virsh console $VM_NAME"
echo ""
echo "–õ–æ–≥–∏–Ω: $USERNAME"
echo "–ü–∞—Ä–æ–ª—å: $PASSWORD"
echo ""
echo "–î–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –Ω–∞–∂–º–∏—Ç–µ: Ctrl + ]"
echo ""
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```bash
# –°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x scripts/fix-vm-console-password.sh

# –ó–∞–ø—É—Å—Ç–∏—Ç—å
./scripts/fix-vm-console-password.sh dns-server ubuntu ubuntu
```

---

**–ê–≤—Ç–æ—Ä:** Senior DevOps Engineer
**–î–∞—Ç–∞:** 2025-11-21
**–í–µ—Ä—Å–∏—è:** 1.0
